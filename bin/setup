#!/bin/bash -eu

source /etc/jelastic/environment;

/sbin/iptables -t nat -I PREROUTING -p tcp -m tcp --dport 4949 -j REDIRECT --to-ports 9990
/sbin/iptables -t nat -I PREROUTING -p tcp -m tcp --dport 4848 -j REDIRECT --to-ports 9993
service iptables save

mkdir ${OPENSHIFT_JBOSSAS_DIR}/pid ${OPENSHIFT_JBOSSAS_DIR}/logs;

sed -i 's/opt\/repo:\/bin\/bash/opt\/repo\/home:\/bin\/bash/g' "/etc/passwd"

[ -f ${OPENSHIFT_HOMEDIR}/.jboss-cli-history ] || touch ${OPENSHIFT_HOMEDIR}/.jboss-cli-history

if [ -d "${OPENSHIFT_JBOSSAS_DIR}/.ssh" ] ; then
    mv ${OPENSHIFT_JBOSSAS_DIR}/.ssh ${OPENSHIFT_JBOSSAS_DIR}/home/
fi

[ -f "${OPENSHIFT_JBOSSAS_DIR}/.bash_profile" ] && cp ${OPENSHIFT_JBOSSAS_DIR}/.bash_profile ${OPENSHIFT_JBOSSAS_DIR}/home/
[ -f "${OPENSHIFT_JBOSSAS_DIR}/.bash_history" ] && cp ${OPENSHIFT_JBOSSAS_DIR}/.bash_history /opt/repo/home/ ;
[ -f "${OPENSHIFT_JBOSSAS_DIR}/.profile" ] && cp ${OPENSHIFT_JBOSSAS_DIR}/.profile /opt/repo/home/ ;
